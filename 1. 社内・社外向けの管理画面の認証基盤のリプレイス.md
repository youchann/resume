※社内の評価会にて作成した資料を外部向けに修正したものとなります

## 概要

社内・社外向け管理画面内製の認証基盤から Auth0 を用いた認証基盤へのリプレイスを技術選定の段階から1人で行いました。

## 期間

2021年〜半年以内

## 背景

- IDaaS を用いない認証基盤のデメリット
  - 強固な認証を入れづらい(2FA など)
  - パスワードを自前で持つことによる危殆化リスク
- 社内で作るサービスそれぞれで認証を用意しなければならない状態になっている
  - アカウント棚卸しもそれぞれのサービスでやる必要がある
  - サービスを複数利用される顧客もいるのでなるべく統一したい

## どのように行ったのか

### 情報整理

上司から振られたタスクだったので既存のIssueなどを参照しつつ、先述の背景で書いたような問題の理解を先んじて進めました。
加えて今後の管理画面にどういった属性のユーザーが利用するのかを周囲にヒアリングしました。属性の異なるユーザーや、社内の別サービスからも参照されることが明らかになったので、エンドポイント単位で認証方法を切り替えられる作りにするべきだということが明らかになりました。

### 技術選定

https://booth.pm/ja/items/1837928 を参考に選定を進めました。結果的にAuth0を選択することにしました。
https://qiita.com/yutaro50/items/55455fe34385852d5ac0 の方で詳しく書いてあります。

### 実行

どのように設計・実装していったのかと、どのようにユーザーを Auth0 に import したのかを下記に書いていきます。

#### 設計・実装

同一のWebアプリケーション環境で社内・社外向けに管理画面が提供されていることを考慮し、徐々にAuth0を用いた認証に切り替えていくことを画策しました。

具体的には下記のような戦略となります。

1. 特定のURLで開発者自身がAuth0で認証をできるように
2. 特定のURLで社内ユーザーがAuth0で認証できるように
3. 特定のURLですべてのユーザーがAuth0で認証できるように
4. 認証方式が変わる旨を顧客にアナウンス
  - 旧認証を前提としたスクレイパーを動かしている顧客がいるため
  - 1ヶ月程度移行期間を置く
5. すべてのユーザーがAuth0認証をデフォルトで行うように
6. 旧認証関連の機能を取り除く

また認証方法をどのように保持するかについてを、Auth0のドキュメントを読んだり、社内のセキュリティチームに相談しながら決めていきました。管理画面の環境はレガシーなMPAとそれをリプレイスしたSPAの双方が存在し、両者ともドメインが同一である特性から[こちらの記事](https://auth0.com/docs/manage-users/cookies/spa-authenticate-with-cookies)にあるようなCookieを用いた認証を行う方針にしました。

（実装に関する記述はGitHubのPull Requestを参照していたため割愛）

#### ユーザーを Auth0 に import

登録する際に有用そうなエンドポイントを探すことから着手しました。具体的には下記となります。

- https://auth0.com/docs/api/management/v2#!/Jobs/post_users_imports
- https://auth0.com/docs/api/management/v2#!/Users/post_users

前者の場合は一括でImportが可能なので、真っ先に開発用のテナントで試しました。しかし今回ユーザーはパスワードを用いない認証形式「`email`」というコネクションで登録をする必要があり、当該のエンドポイントでそのような登録を行うことが不可能だということが明らかになりました。

よって後者のエンドポイントを用いて1人ずつユーザーを登録していく方針にしました。

手元に本番環境のユーザー一覧のEmailをCSV形式で取り込んだ後、それを用いてAuth0のエンドポイントを叩くNode.jsのスクリプトを書きました。社内のエンジニアにコードのレビューをいただいた後、ダミーのCSVで開発用テナントに対して検証を行いました。意図通りに登録処理が行われていることを確認してから、本番環境のテナントにユーザーのImportを行いました。

### 落ち穂拾い

社外のユーザーに対して切り替えの1ヶ月ほど前からアナウンスを行いました。

切り替え後の問い合わせに対してもいくつかありましたが対応しました。その時の記事が下記になります。
https://qiita.com/yutaro50/items/8086a1f986242921515c

旧認証基盤の撤去も後に行いました。

## まとめ

古くから内製で運用されていた認証基盤をリプレイスしたことで、セキュリティまわりのリスク低減に貢献しました。
またサービスを落とすことなく、段階的にリプレイスを進めることができました。
